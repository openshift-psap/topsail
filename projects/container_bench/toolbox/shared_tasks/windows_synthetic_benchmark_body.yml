---
# Default benchmark body for Windows platforms
# Usage: include_tasks: "../../shared_tasks/windows_default_benchmark_body.yml"
# Requires: image_to_pull, prepare_commands, benchmark_command, cleanup_commands variables

- name: Validate required variables
  fail:
    msg: "Required variable '{{ item }}' is not defined"
  when: vars[item] is not defined
  loop:
    - prepare_commands
    - benchmark_command
    - cleanup_commands
    - log_file_name

- name: Create benchmark artifacts directory
  include_tasks: "create_artifacts_dir.yml"

- name: Perform full container resource cleanup before benchmark
  include_tasks: "cleanup_container_resources.yml"

- name: Pull required container image (with local tarfile optimization)
  include_tasks: "pull_image.yml"
  vars:
    image_name: "{{ image_to_pull }}"
  when: image_to_pull is defined and image_to_pull | length > 0

- name: Execute benchmark preparation commands
  ansible.windows.win_shell: "{{ prepare_commands }}"
  when: prepare_commands | length > 0

- name: Record benchmark start time
  ansible.windows.win_shell: "Get-Date -Format 'yyyy-MM-dd HH:mm:ss'"
  register: benchmark_start_time

- name: Execute benchmark measurement
  ansible.windows.win_shell: "{{ benchmark_command }}"
  register: benchmark_output

- name: Save benchmark output to file
  ansible.windows.win_copy:
    content: "{{ benchmark_output.stdout }}{{ benchmark_output.stderr }}"
    dest: "{{ artifact_extra_logs_dir }}/artifacts/{{ log_file_name }}"

- name: Save benchmark timestamp
  ansible.windows.win_copy:
    content: |
      start_time: {{ benchmark_start_time.stdout | trim }}
    dest: "{{ artifact_extra_logs_dir }}/artifacts/{{ log_file_name | replace('.log', '_ts.yaml') }}"

- name: Execute benchmark cleanup commands
  ansible.windows.win_shell: "{{ cleanup_commands }}"
  when: cleanup_commands | length > 0

- name: Perform full container resource cleanup after benchmark
  include_tasks: "cleanup_container_resources.yml"
