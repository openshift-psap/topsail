---
# Shared task for optimized image pulling/loading
# Usage:
# - include_tasks: "../../shared_tasks/pull_image.yml"
#   vars:
#     image_name: "quay.io/example/image:tag"  # Single image
# OR
# - include_tasks: "../../shared_tasks/pull_image.yml"
#   vars:
#     images_to_pull: ["image1:tag", "image2:tag"]  # Multiple images
# Requires: binary_path, additional_args, and either image_name or images_to_pull variables
# Note: Image names are sanitized by replacing all special characters with '_'

- name: Validate required variables for image pulling
  fail:
    msg: "Required variable '{{ item }}' is not defined"
  when: vars[item] is not defined
  loop:
    - binary_path
    - environment

- name: Validate at least one image source is defined
  fail:
    msg: "Either 'image_name' or 'images_to_pull' must be defined"
  when: (image_name is not defined or image_name | length == 0) and (images_to_pull is not defined or images_to_pull | length == 0)

- name: Convert single image_name to list
  set_fact:
    images_list: "{{ [image_name] if (image_name is defined and image_name | length > 0) else images_to_pull }}"

- name: Set path to directory with images tarfiles
  set_fact:
    images_path: "{{ vars['environment'][0]['HOME'] + '\\images' if ansible_os_family == 'Windows' else vars['environment'][0]['HOME'] + '/images' }}"

- name: Ensure images directory exists (Unix/Linux/macOS)
  file:
    path: "{{ images_path }}"
    state: directory
    mode: '0755'
  when: ansible_os_family != 'Windows'

- name: Ensure images directory exists (Windows)
  ansible.windows.win_file:
    path: "{{ images_path }}"
    state: directory
  when: ansible_os_family == 'Windows'

- name: Process each image
  include_tasks: pull_single_image.yml
  loop: "{{ images_list }}"
  loop_control:
    loop_var: current_image_name
    label: "{{ current_image_name }}"
